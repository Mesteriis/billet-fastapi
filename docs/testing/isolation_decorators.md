# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤

–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤ –æ—Ç –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤, —Ä–µ—à–∞—é—â–∞—è –ø—Ä–æ–±–ª–µ–º—É –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏.

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 4 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑–æ–ª—è—Ü–∏–∏, –∫–∞–∂–¥–∞—è —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–∞–º–∏ –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å—é:

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è                   | –°–∫–æ—Ä–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å    | –†–µ—Å—É—Ä—Å—ã | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ           |
| --------------------------- | -------- | ------------- | ------- | -------------------- |
| `transaction_isolated_test` | ‚ö°‚ö°‚ö°   | ‚≠ê‚≠ê‚≠ê        | üíö      | –ë—ã—Å—Ç—Ä—ã–µ unit-—Ç–µ—Å—Ç—ã   |
| `schema_isolated_test`      | ‚ö°‚ö°     | ‚≠ê‚≠ê‚≠ê‚≠ê      | üíõ      | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã |
| `database_reset_test`       | ‚ö°       | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê    | üß°      | –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã      |
| `complete_isolation_test`   | üêå       | ‚ö†Ô∏è **–û–®–ò–ë–ö–ò** | ‚ù§Ô∏è      | **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** |

## –ò–º–ø–æ—Ä—Ç

```python
from tests.utils_test.isolation_decorators import (
    transaction_isolated_test,
    database_reset_test,
    schema_isolated_test,
    complete_isolation_test,
    isolated_data_context,
)
```

## –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑–æ–ª—è—Ü–∏–∏

### 1. Transaction Isolation (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤)

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç PostgreSQL savepoints –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è.

```python
@transaction_isolated_test(verbose=True)
async def test_user_creation(setup_test_models):
    """–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–∫–∞—á–µ–Ω—ã –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞."""
    session = setup_test_models

    user = await UserFactory.create(username="test_user")
    post = await PostFactory.create(title="Test Post", author=user)

    assert user.id is not None
    assert post.author_id == user.id

    # –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç—è—Ç—Å—è
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- ‚ö° –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–æ–¥ (~10-20% –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ ACID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- ‚ö†Ô∏è –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å DDL –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ (CREATE/DROP TABLE)
- ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º–∏ COMMIT/ROLLBACK

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

- Unit-—Ç–µ—Å—Ç—ã —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º/–∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- –¢–µ—Å—Ç—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### 2. Schema Isolation (–ë–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∏–∑–æ–ª—è—Ü–∏–∏)

**–ü—Ä–∏–Ω—Ü–∏–ø:** –°–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é PostgreSQL —Å—Ö–µ–º—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞. –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Å —É–º–µ—Ä–µ–Ω–Ω—ã–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏.

```python
@schema_isolated_test(verbose=True)
async def test_complex_workflow(setup_test_models):
    """–¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å—Ö–µ–º–µ."""
    session = setup_test_models

    # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    users = await UserFactory.create_batch(5)
    categories = await CategoryFactory.create_batch(3)

    for user in users:
        posts = await PostFactory.create_batch(
            2,
            author=user,
            category=categories[0]
        )

    # –°—Ö–µ–º–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- üîí –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è - –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –≤ —Å–≤–æ–µ–π —Å—Ö–µ–º–µ
- üöÄ –£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (~50-100% –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ SQL –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π —Å—Ö–µ–º—ã

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- üíæ –ë–æ–ª—å—à–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ë–î
- ‚è±Ô∏è –í—Ä–µ–º—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –¢–µ—Å—Ç—ã —Å–æ —Å–ª–æ–∂–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –¢–µ—Å—Ç—ã —Å DDL –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

### 3. Database Reset (–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å)

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–µ—Ç –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º. 100% –≥–∞—Ä–∞–Ω—Ç–∏—è —á–∏—Å—Ç–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö.

```python
@database_reset_test(verbose=True)
async def test_from_scratch(setup_test_models):
    """–ë–î –ø–æ–ª–Ω–æ—Å—Ç—å—é —á–∏—Å—Ç–∞—è –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º."""
    session = setup_test_models

    # –ù–∞—á–∏–Ω–∞–µ–º —Å –∞–±—Å–æ–ª—é—Ç–Ω–æ —á–∏—Å—Ç–æ–π –ë–î
    admin = await UserFactory.create(
        username="admin",
        is_superuser=True
    )

    # –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    setup_data = await create_initial_data(admin)

    # –¢–µ—Å—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
    assert_initial_state(setup_data)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**

- üèÜ 100% –≥–∞—Ä–∞–Ω—Ç–∏—è —á–∏—Å—Ç–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- üßº –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
- üîÑ –°–±—Ä–æ—Å –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∏–∑–æ–ª—è—Ü–∏–µ–π

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**

- üêå –°–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π (~200-500% –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤)
- üí™ –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã
- –¢–µ—Å—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
- –¢–µ—Å—Ç—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —á–∏—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –î–µ–±–∞–≥ –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö

### 4. Complete Isolation ‚ö†Ô∏è **–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø - –ò–ú–ï–ï–¢ –û–®–ò–ë–ö–ò**

**–í–ù–ò–ú–ê–ù–ò–ï:** –≠—Ç–æ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–º–µ–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—á–∏—Å—Ç–∫–æ–π —Å—Ö–µ–º –ø—Ä–∏ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö.

**–ü—Ä–æ–±–ª–µ–º—ã:**

- üö´ –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ —Ç–µ—Å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
- üö´ –ù–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å `SET search_path TO public` –≤ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- üö´ –°—Ö–µ–º—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –Ω–µ–æ—á–∏—â–µ–Ω–Ω—ã–º–∏
- üö´ –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–í–º–µ—Å—Ç–æ `@complete_isolation_test()` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:**

```python
# ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø: –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
@database_reset_test(verbose=True)
async def test_critical_workflow(setup_test_models):
    """–ù–∞–¥–µ–∂–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤."""
    session = setup_test_models

    # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∂–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
    users = await UserFactory.create_batch(10)
    # –ë–î –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
```

**–ü–æ—á–µ–º—É `database_reset_test` –ª—É—á—à–µ:**

- ‚úÖ 100% –Ω–∞–¥–µ–∂–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö –≤ —Ç–µ—Å—Ç–∞—Ö
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏ –ø–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

**–°—Ç–∞—Ç—É—Å:** –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –æ—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

## –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

–î–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `isolated_data_context`:

```python
async def test_partial_isolation(setup_test_models):
    session = setup_test_models

    # –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    permanent_user = await UserFactory.create(username="permanent")

    # –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫
    async with isolated_data_context(session, strategy="transaction"):
        # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        temp_user = await UserFactory.create(username="temporary")
        temp_posts = await PostFactory.create_batch(3, author=temp_user)

        # –î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ

    # temp_user –∏ temp_posts –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã
    # permanent_user –æ—Å—Ç–∞–ª—Å—è
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:

```python
@transaction_isolated_test(cleanup_on_error=True, verbose=True)
async def test_with_error_handling(setup_test_models):
    session = setup_test_models

    user = await UserFactory.create(username="test_user")

    try:
        # –ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É
        risky_operation(user)
    except SomeException:
        # –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–µ–Ω—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        pass
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤

### –û–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

- `cleanup_on_error: bool = True` - –û—á–∏—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- `verbose: bool = False` - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑–æ–ª—è—Ü–∏–∏

### –ü—Ä–∏–º–µ—Ä —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

```python
@transaction_isolated_test(
    cleanup_on_error=False,  # –û—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–ª—è –¥–µ–±–∞–≥–∞
    verbose=True             # –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
)
async def test_debug_mode(setup_test_models):
    # –¢–µ—Å—Ç —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    pass
```

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü—Ä–∏–º–µ—Ä–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–∑–¥–∞–Ω–∏—è 100 –∑–∞–ø–∏—Å–µ–π):

```python
# –ë–µ–∑ –∏–∑–æ–ª—è—Ü–∏–∏
create_100_records()  # ~0.1s

# –° –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏
@transaction_isolated_test()      # ~0.12s (+20%)
@schema_isolated_test()          # ~0.15s (+50%)
@database_reset_test()           # ~0.3s (+200%)
@complete_isolation_test()       # ~0.5s (+400%)
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–µ—Å—Ç–æ–≤

1. **Unit-—Ç–µ—Å—Ç—ã (95% —Å–ª—É—á–∞–µ–≤)**

   ```python
   @transaction_isolated_test()
   ```

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**

   ```python
   @schema_isolated_test()
   ```

3. **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ/E2E —Ç–µ—Å—Ç—ã**
   ```python
   @database_reset_test()  # ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
   # –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ @complete_isolation_test() - –∏–º–µ–µ—Ç –æ—à–∏–±–∫–∏!
   ```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤

```python
@transaction_isolated_test()
async def test_concurrent_safe(setup_test_models):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è."""
    unique_id = uuid.uuid4().hex[:8]

    user = await UserFactory.create(
        username=f"user_{unique_id}",
        email=f"user_{unique_id}@example.com"
    )

    # –ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç –¥—Ä—É–≥–∏—Ö
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```python
@database_reset_test()
async def test_migration_workflow(setup_test_models):
    """–¢–µ—Å—Ç —Å —á–∏—Å—Ç–æ–π –ë–î –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π."""
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é
    apply_migration("001_initial")

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —á–∏—Å—Ç–æ–π –ë–î
    check_migration_result()
```

#### –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
class TestUserWorkflow:
    @transaction_isolated_test()
    async def test_user_creation(self, setup_test_models):
        """–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        pass

    @schema_isolated_test()
    async def test_user_complex_workflow(self, setup_test_models):
        """–°–ª–æ–∂–Ω—ã–π workflow —Å –∏–∑–æ–ª—è—Ü–∏–µ–π."""
        pass

    @database_reset_test()
    async def test_user_system_integration(self, setup_test_models):
        """–ü–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–µ—Å—Ç."""
        pass
```

## –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∏–∑–æ–ª—è—Ü–∏–µ–π

### –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
@transaction_isolated_test(verbose=True)
async def test_with_debug_logs(setup_test_models):
    # –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑–æ–ª—è—Ü–∏–∏
    pass
```

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è –¥–µ–±–∞–≥–∞

```python
@transaction_isolated_test(cleanup_on_error=False)
async def test_debug_data_left(setup_test_models):
    # –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –ë–î –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    pass
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏

```python
async def test_isolation_verification(setup_test_models):
    """–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–∑–æ–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."""

    # –¢–µ—Å—Ç 1: —Å–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    async with isolated_data_context(setup_test_models):
        user1 = await UserFactory.create(username="isolated_user")
        assert user1.id is not None

    # –¢–µ—Å—Ç 2: –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å
    async with isolated_data_context(setup_test_models):
        # –ë–î –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å—Ç–æ–π
        users_count = await count_users(setup_test_models)
        assert users_count == 0
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏

### –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

1. **–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã**

   ```bash
   # –¢–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
   pytest -n 4 tests/problem_tests/
   ```

2. **–î–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–ª—è—Ü–∏—é**

   ```python
   # –ë—ã–ª–æ
   async def test_user_creation(setup_test_models):
       pass

   # –°—Ç–∞–ª–æ
   @transaction_isolated_test()
   async def test_user_creation(setup_test_models):
       pass
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
   ```bash
   # –î–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   pytest -n 4 tests/fixed_tests/
   ```

### –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤

```python
# –í pyproject.toml
[tool.pytest.ini_options]
markers = [
    "isolated: tests with data isolation",
    "transaction_isolated: tests with transaction isolation",
    "schema_isolated: tests with schema isolation",
    "database_reset: tests with database reset",
]

# –í —Ç–µ—Å—Ç–∞—Ö
@pytest.mark.isolated
@transaction_isolated_test()
async def test_with_marker(setup_test_models):
    pass
```

### –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

```bash
# –¢–æ–ª—å–∫–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest -m "isolated"

# –ò—Å–∫–ª—é—á–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª—è—Ü–∏–∏
pytest -m "not database_reset"

# –¢–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest -m "transaction_isolated"
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**

   - 90%+ —Ç–µ—Å—Ç–æ–≤: `@transaction_isolated_test()`
   - –°–ª–æ–∂–Ω—ã–µ —Ç–µ—Å—Ç—ã: `@schema_isolated_test()`
   - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: `@database_reset_test()`

2. **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–∞–±—Ä–∏–∫–∞–º–∏**

   ```python
   @transaction_isolated_test()
   async def test_with_factories(setup_test_models):
       # ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–±—Ä–∏–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
       user = await UserFactory.create()

       # ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é
       # user = TestUser(username="test")
   ```

3. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

   ```python
   @transaction_isolated_test()
   async def test_unique_data(setup_test_models):
       # ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
       unique_id = uuid.uuid4().hex[:8]
       user = await UserFactory.create(username=f"user_{unique_id}")
   ```

4. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤**

   ```python
   class TestUserIsolated:
       """–í—Å–µ —Ç–µ—Å—Ç—ã —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã."""

       @transaction_isolated_test()
       async def test_create_user(self, setup_test_models):
           pass

       @transaction_isolated_test()
       async def test_update_user(self, setup_test_models):
           pass
   ```

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∏–∑–æ–ª—è—Ü–∏–∏

```python
# –ú–µ–¥–ª–µ–Ω–Ω–æ
@database_reset_test()
async def test_simple_operation(setup_test_models):
    pass

# –ë—ã—Å—Ç—Ä–æ
@transaction_isolated_test()
async def test_simple_operation(setup_test_models):
    pass
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:** –í–∫–ª—é—á–∏—Ç–µ verbose —Ä–µ–∂–∏–º –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```python
@transaction_isolated_test(verbose=True)
async def test_debug_isolation(setup_test_models):
    # –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑–æ–ª—è—Ü–∏–∏
    pass
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ schema isolation

```python
# –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
@transaction_isolated_test()  # –ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å

# –†–µ—à–µ–Ω–∏–µ
@schema_isolated_test()       # –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ—Ö–≤–∞—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ë–î

**–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑–æ–ª—è—Ü–∏–∏

```python
# –ú–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤
@complete_isolation_test()

# –ú–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ
@schema_isolated_test()

# –ú–∏–Ω–∏–º—É–º —Ä–µ—Å—É—Ä—Å–æ–≤
@transaction_isolated_test()
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∏–∑–æ–ª—è—Ü–∏–∏ —Ä–µ—à–∞—é—Ç –æ–¥–Ω—É –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ - –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏. –í—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:

- **–ë—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ:** `@transaction_isolated_test()`
- **–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ:** `@schema_isolated_test()`
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–¥–µ–∂–Ω–æ:** `@database_reset_test()` –∏–ª–∏ `@complete_isolation_test()`

–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑–æ–ª—è—Ü–∏–∏ –æ–±–µ—Å–ø–µ—á–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
