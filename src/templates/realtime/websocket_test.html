<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket –¢–µ—Å—Ç —Å –ë–∏–Ω–∞—Ä–Ω—ã–º–∏ –î–∞–Ω–Ω—ã–º–∏ –∏ WebRTC</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #ecf0f1;
      }
      .tab {
        padding: 10px 20px;
        background: #ecf0f1;
        cursor: pointer;
        border: none;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        transition: all 0.3s ease;
      }
      .tab.active {
        background: #3498db;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .connection-status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .status-disconnected {
        background: #e74c3c;
        color: white;
      }
      .status-connecting {
        background: #f39c12;
        color: white;
      }
      .status-connected {
        background: #27ae60;
        color: white;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
      }
      button {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .messages {
        height: 300px;
        overflow-y: auto;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 5px;
        word-wrap: break-word;
      }
      .message-sent {
        background: #d5f4e6;
        border-left: 4px solid #27ae60;
      }
      .message-received {
        background: #fdeaa7;
        border-left: 4px solid #f39c12;
      }
      .message-error {
        background: #fab1a0;
        border-left: 4px solid #e74c3c;
      }
      .message-binary {
        background: #dda0dd;
        border-left: 4px solid #9932cc;
      }
      .binary-upload {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }
      .file-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .webrtc-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      .video-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
      }
      video {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }
      .video-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
      }
      .webrtc-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
        font-size: 12px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .stat-label {
        color: #7f8c8d;
        font-size: 12px;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ WebSocket –¢–µ—Å—Ç —Å –ë–∏–Ω–∞—Ä–Ω—ã–º–∏ –î–∞–Ω–Ω—ã–º–∏ –∏ WebRTC</h1>

      <div class="connection-status" id="connectionStatus">
        <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('basic')">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
        <button class="tab" onclick="showTab('binary')">–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="tab" onclick="showTab('webrtc')">WebRTC</button>
        <button class="tab" onclick="showTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ -->
      <div id="basic" class="tab-content active">
        <div class="form-group">
          <label for="wsUrl">WebSocket URL:</label>
          <input
            type="text"
            id="wsUrl"
            value="ws://localhost:8000/realtime/ws"
            placeholder="ws://localhost:8000/realtime/ws"
          />
        </div>

        <div class="form-group">
          <label for="authToken">–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
          <input
            type="text"
            id="authToken"
            placeholder="Bearer token –∏–ª–∏ API key"
          />
        </div>

        <button onclick="connect()" id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>
          –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
        </button>

        <div class="form-group">
          <label for="messageText">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
          <textarea
            id="messageText"
            rows="3"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="channel">–ö–∞–Ω–∞–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
          <input type="text" id="channel" placeholder="general" />
        </div>

        <button onclick="sendMessage()" id="sendBtn" disabled>
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
        <button onclick="ping()" id="pingBtn" disabled>Ping</button>
        <button onclick="subscribeToChannel()" id="subscribeBtn" disabled>
          –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
        </button>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
      <div id="binary" class="tab-content">
        <div class="form-group">
          <label for="fileInput">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</label>
          <div class="binary-upload">
            <input
              type="file"
              id="fileInput"
              onchange="handleFileSelect(event)"
            />
            <button onclick="sendBinaryFile()" id="sendFileBtn" disabled>
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª
            </button>
          </div>
          <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="form-group">
          <label for="binaryText"
            >–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</label
          >
          <textarea
            id="binaryText"
            rows="3"
            placeholder="–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
          ></textarea>
          <button onclick="sendBinaryText()" id="sendBinaryBtn" disabled>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ Binary
          </button>
        </div>

        <div class="form-group">
          <label>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:</label>
          <button onclick="generateRandomBinary()" id="generateBtn" disabled>
            –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          </button>
          <button onclick="generateImage()" id="generateImageBtn" disabled>
            –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          </button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ WebRTC -->
      <div id="webrtc" class="tab-content">
        <div class="form-group">
          <label for="peerId">ID –ø–∏—Ä–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</label>
          <input type="text" id="peerId" placeholder="peer_123" />
          <button onclick="createOffer()" id="createOfferBtn" disabled>
            –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
          </button>
          <button onclick="createAnswer()" id="createAnswerBtn" disabled>
            –°–æ–∑–¥–∞—Ç—å –æ—Ç–≤–µ—Ç
          </button>
        </div>

        <div class="form-group">
          <label for="roomId">ID –∫–æ–º–Ω–∞—Ç—ã:</label>
          <input
            type="text"
            id="roomId"
            placeholder="room_abc"
            value="room_123"
          />
          <button onclick="joinRoom()" id="joinRoomBtn" disabled>
            –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É
          </button>
          <button onclick="leaveRoom()" id="leaveRoomBtn" disabled>
            –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
          </button>
        </div>

        <div class="webrtc-controls">
          <div class="video-container">
            <video id="localVideo" autoplay muted></video>
            <div class="video-label">–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ</div>
          </div>
          <div class="video-container">
            <video id="remoteVideo" autoplay></video>
            <div class="video-label">–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</div>
          </div>
        </div>

        <button onclick="startLocalVideo()" id="startVideoBtn">
          –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
        <button onclick="stopLocalVideo()" id="stopVideoBtn" disabled>
          –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
        <button onclick="toggleAudio()" id="toggleAudioBtn" disabled>
          –í–∫–ª/–í—ã–∫–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω
        </button>
        <button onclick="toggleVideo()" id="toggleVideoBtn" disabled>
          –í–∫–ª/–í—ã–∫–ª –≤–∏–¥–µ–æ
        </button>

        <div class="webrtc-info" id="webrtcInfo">
          WebRTC —Å—Ç–∞—Ç—É—Å: –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div id="stats" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="messagesSent">0</div>
            <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="messagesReceived">0</div>
            <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—É—á–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="binaryDataSent">0 KB</div>
            <div class="stat-label">–ë–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="connectionTime">0s</div>
            <div class="stat-label">–í—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="connectionId">-</div>
            <div class="stat-label">ID –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="webrtcPeers">0</div>
            <div class="stat-label">WebRTC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="messages">–õ–æ–≥ —Å–æ–æ–±—â–µ–Ω–∏–π:</label>
        <div class="messages" id="messages"></div>
        <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>
    </div>

    <script>
      let ws = null;
      let connectionStartTime = null;
      let stats = {
        messagesSent: 0,
        messagesReceived: 0,
        binaryDataSent: 0,
      };
      let localStream = null;
      let peerConnection = null;
      let dataChannel = null;
      let currentPeerId = null;

      // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      const rtcConfiguration = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      function showTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      function updateConnectionStatus(status, text) {
        const statusElement = document.getElementById("connectionStatus");
        const statusText = document.getElementById("statusText");

        statusElement.className = "connection-status status-" + status;
        statusText.textContent = text;
      }

      function updateStats() {
        document.getElementById("messagesSent").textContent =
          stats.messagesSent;
        document.getElementById("messagesReceived").textContent =
          stats.messagesReceived;
        document.getElementById("binaryDataSent").textContent =
          (stats.binaryDataSent / 1024).toFixed(2) + " KB";

        if (connectionStartTime) {
          const uptime = Math.floor((Date.now() - connectionStartTime) / 1000);
          document.getElementById("connectionTime").textContent = uptime + "s";
        }
      }

      function addMessage(message, type = "received") {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message message-${type}`;

        const timestamp = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        if (type === "received") {
          stats.messagesReceived++;
          updateStats();
        }
      }

      function connect() {
        const url = document.getElementById("wsUrl").value;
        const token = document.getElementById("authToken").value;

        let wsUrl = url;
        if (token) {
          wsUrl += `?token=${encodeURIComponent(token)}`;
        }

        try {
          updateConnectionStatus("connecting", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
          ws = new WebSocket(wsUrl);

          ws.onopen = function (event) {
            updateConnectionStatus("connected", "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
            connectionStartTime = Date.now();

            document.getElementById("connectBtn").disabled = true;
            document.getElementById("disconnectBtn").disabled = false;
            document.getElementById("sendBtn").disabled = false;
            document.getElementById("pingBtn").disabled = false;
            document.getElementById("subscribeBtn").disabled = false;
            document.getElementById("sendFileBtn").disabled = false;
            document.getElementById("sendBinaryBtn").disabled = false;
            document.getElementById("generateBtn").disabled = false;
            document.getElementById("generateImageBtn").disabled = false;
            document.getElementById("createOfferBtn").disabled = false;
            document.getElementById("joinRoomBtn").disabled = false;

            addMessage("WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "sent");

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            currentPeerId = "peer_" + Math.random().toString(36).substr(2, 9);
            document.getElementById("connectionId").textContent = currentPeerId;
          };

          ws.onmessage = function (event) {
            let message;

            if (event.data instanceof Blob) {
              // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
              const reader = new FileReader();
              reader.onload = function (e) {
                const binaryData = new Uint8Array(e.target.result);
                addMessage(
                  `–ü–æ–ª—É—á–µ–Ω—ã –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${binaryData.length} –±–∞–π—Ç`,
                  "binary"
                );
              };
              reader.readAsArrayBuffer(event.data);
              return;
            }

            try {
              message = JSON.parse(event.data);
            } catch (e) {
              message = event.data;
            }

            if (typeof message === "object" && message.type === "webrtc") {
              handleWebRTCMessage(message);
            } else if (typeof message === "object" && message.binary_data) {
              // –û–±—Ä–∞–±–æ—Ç–∫–∞ base64 –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
              const binarySize = atob(message.binary_data).length;
              addMessage(
                `–ü–æ–ª—É—á–µ–Ω—ã –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (base64): ${binarySize} –±–∞–π—Ç, —Ç–∏–ø: ${message.type}`,
                "binary"
              );
            } else {
              addMessage(
                `–ü–æ–ª—É—á–µ–Ω–æ: ${JSON.stringify(message, null, 2)}`,
                "received"
              );
            }
          };

          ws.onclose = function (event) {
            updateConnectionStatus("disconnected", "–û—Ç–∫–ª—é—á–µ–Ω–æ");

            document.getElementById("connectBtn").disabled = false;
            document.getElementById("disconnectBtn").disabled = true;
            document.getElementById("sendBtn").disabled = true;
            document.getElementById("pingBtn").disabled = true;
            document.getElementById("subscribeBtn").disabled = true;
            document.getElementById("sendFileBtn").disabled = true;
            document.getElementById("sendBinaryBtn").disabled = true;
            document.getElementById("generateBtn").disabled = true;
            document.getElementById("generateImageBtn").disabled = true;
            document.getElementById("createOfferBtn").disabled = true;
            document.getElementById("joinRoomBtn").disabled = true;

            addMessage(
              `WebSocket –∑–∞–∫—Ä—ã—Ç. –ö–æ–¥: ${event.code}, –ü—Ä–∏—á–∏–Ω–∞: ${event.reason}`,
              "error"
            );
            connectionStartTime = null;
          };

          ws.onerror = function (error) {
            updateConnectionStatus("disconnected", "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
            addMessage(`–û—à–∏–±–∫–∞ WebSocket: ${error}`, "error");
          };
        } catch (error) {
          updateConnectionStatus("disconnected", "–û—à–∏–±–∫–∞");
          addMessage(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, "error");
        }
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WebRTC
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }

        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }
      }

      function sendMessage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const text = document.getElementById("messageText").value;
        const channel = document.getElementById("channel").value;

        const message = {
          action: "send_message",
          data: {
            text: text,
            channel: channel || null,
          },
        };

        ws.send(JSON.stringify(message));
        addMessage(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${JSON.stringify(message)}`, "sent");

        stats.messagesSent++;
        updateStats();

        document.getElementById("messageText").value = "";
      }

      function ping() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const message = { action: "ping" };
        ws.send(JSON.stringify(message));
        addMessage("Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", "sent");

        stats.messagesSent++;
        updateStats();
      }

      function subscribeToChannel() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const channel = document.getElementById("channel").value;
        if (!channel) {
          addMessage("–£–∫–∞–∂–∏—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏", "error");
          return;
        }

        const message = {
          action: "subscribe",
          data: { channel: channel },
        };

        ws.send(JSON.stringify(message));
        addMessage(`–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª: ${channel}`, "sent");

        stats.messagesSent++;
        updateStats();
      }

      // –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          const fileInfo = document.getElementById("fileInfo");
          fileInfo.innerHTML = `
                    <strong>–§–∞–π–ª:</strong> ${file.name}<br>
                    <strong>–†–∞–∑–º–µ—Ä:</strong> ${(file.size / 1024).toFixed(
                      2
                    )} KB<br>
                    <strong>–¢–∏–ø:</strong> ${file.type || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
                `;
        }
      }

      function sendBinaryFile() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          addMessage("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const arrayBuffer = e.target.result;
          const base64Data = btoa(
            String.fromCharCode(...new Uint8Array(arrayBuffer))
          );

          const message = {
            action: "send_binary",
            binary_data: base64Data,
            data: {
              filename: file.name,
              content_type: file.type || "application/octet-stream",
              size: file.size,
            },
          };

          ws.send(JSON.stringify(message));
          addMessage(
            `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª: ${file.name} (${(file.size / 1024).toFixed(
              2
            )} KB)`,
            "sent"
          );

          stats.messagesSent++;
          stats.binaryDataSent += file.size;
          updateStats();
        };
        reader.readAsArrayBuffer(file);
      }

      function sendBinaryText() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const text = document.getElementById("binaryText").value;
        if (!text) {
          addMessage("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
          return;
        }

        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const base64Data = btoa(String.fromCharCode(...data));

        const message = {
          action: "send_binary",
          binary_data: base64Data,
          data: {
            content_type: "text/plain",
            size: data.length,
          },
        };

        ws.send(JSON.stringify(message));
        addMessage(
          `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${data.length} –±–∞–π—Ç`,
          "sent"
        );

        stats.messagesSent++;
        stats.binaryDataSent += data.length;
        updateStats();

        document.getElementById("binaryText").value = "";
      }

      function generateRandomBinary() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (1KB)
        const size = 1024;
        const data = new Uint8Array(size);
        for (let i = 0; i < size; i++) {
          data[i] = Math.floor(Math.random() * 256);
        }

        const base64Data = btoa(String.fromCharCode(...data));

        const message = {
          action: "send_binary",
          binary_data: base64Data,
          data: {
            content_type: "application/octet-stream",
            size: size,
            description: "–°–ª—É—á–∞–π–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ",
          },
        };

        ws.send(JSON.stringify(message));
        addMessage(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${size} –±–∞–π—Ç`, "sent");

        stats.messagesSent++;
        stats.binaryDataSent += size;
        updateStats();
      }

      function generateImage() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ canvas
        const canvas = document.createElement("canvas");
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext("2d");

        // –†–∏—Å—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç
        const gradient = ctx.createLinearGradient(0, 0, 200, 200);
        gradient.addColorStop(0, "#3498db");
        gradient.addColorStop(1, "#9b59b6");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 200, 200);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Test Image", 100, 100);
        ctx.fillText(new Date().toLocaleTimeString(), 100, 130);

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ blob –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        canvas.toBlob(function (blob) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const arrayBuffer = e.target.result;
            const base64Data = btoa(
              String.fromCharCode(...new Uint8Array(arrayBuffer))
            );

            const message = {
              action: "send_binary",
              binary_data: base64Data,
              data: {
                filename: "test_image.png",
                content_type: "image/png",
                size: arrayBuffer.byteLength,
              },
            };

            ws.send(JSON.stringify(message));
            addMessage(
              `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${(
                arrayBuffer.byteLength / 1024
              ).toFixed(2)} KB`,
              "sent"
            );

            stats.messagesSent++;
            stats.binaryDataSent += arrayBuffer.byteLength;
            updateStats();
          };
          reader.readAsArrayBuffer(blob);
        }, "image/png");
      }

      // WebRTC —Ñ—É–Ω–∫—Ü–∏–∏
      function startLocalVideo() {
        navigator.mediaDevices
          .getUserMedia({ video: true, audio: true })
          .then((stream) => {
            localStream = stream;
            document.getElementById("localVideo").srcObject = stream;

            document.getElementById("startVideoBtn").disabled = true;
            document.getElementById("stopVideoBtn").disabled = false;
            document.getElementById("toggleAudioBtn").disabled = false;
            document.getElementById("toggleVideoBtn").disabled = false;

            addMessage("–õ–æ–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞", "sent");
            updateWebRTCInfo();
          })
          .catch((error) => {
            addMessage(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`, "error");
          });
      }

      function stopLocalVideo() {
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
          document.getElementById("localVideo").srcObject = null;

          document.getElementById("startVideoBtn").disabled = false;
          document.getElementById("stopVideoBtn").disabled = true;
          document.getElementById("toggleAudioBtn").disabled = true;
          document.getElementById("toggleVideoBtn").disabled = true;

          addMessage("–õ–æ–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", "sent");
          updateWebRTCInfo();
        }
      }

      function toggleAudio() {
        if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            addMessage(
              `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${audioTrack.enabled ? "–≤–∫–ª—é—á–µ–Ω" : "–≤—ã–∫–ª—é—á–µ–Ω"}`,
              "sent"
            );
          }
        }
      }

      function toggleVideo() {
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            addMessage(
              `–í–∏–¥–µ–æ ${videoTrack.enabled ? "–≤–∫–ª—é—á–µ–Ω–æ" : "–≤—ã–∫–ª—é—á–µ–Ω–æ"}`,
              "sent"
            );
          }
        }
      }

      function createOffer() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const targetPeerId = document.getElementById("peerId").value;
        if (!targetPeerId) {
          addMessage("–£–∫–∞–∂–∏—Ç–µ ID –ø–∏—Ä–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", "error");
          return;
        }

        setupPeerConnection(targetPeerId);

        peerConnection
          .createOffer()
          .then((offer) => {
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            const message = {
              action: "webrtc_signal",
              data: {
                signal_type: "offer",
                peer_id: currentPeerId,
                target_peer_id: targetPeerId,
                sdp: peerConnection.localDescription.sdp,
                room_id: document.getElementById("roomId").value || null,
              },
            };

            ws.send(JSON.stringify(message));
            addMessage(
              `WebRTC –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è ${targetPeerId}`,
              "sent"
            );

            stats.messagesSent++;
            updateStats();
          })
          .catch((error) => {
            addMessage(
              `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`,
              "error"
            );
          });
      }

      function createAnswer() {
        if (!peerConnection) {
          addMessage("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞", "error");
          return;
        }

        peerConnection
          .createAnswer()
          .then((answer) => {
            return peerConnection.setLocalDescription(answer);
          })
          .then(() => {
            const message = {
              action: "webrtc_signal",
              data: {
                signal_type: "answer",
                peer_id: currentPeerId,
                target_peer_id: document.getElementById("peerId").value,
                sdp: peerConnection.localDescription.sdp,
                room_id: document.getElementById("roomId").value || null,
              },
            };

            ws.send(JSON.stringify(message));
            addMessage("WebRTC –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", "sent");

            stats.messagesSent++;
            updateStats();
          })
          .catch((error) => {
            addMessage(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: ${error.message}`, "error");
          });
      }

      function joinRoom() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const roomId = document.getElementById("roomId").value;
        if (!roomId) {
          addMessage("–£–∫–∞–∂–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã", "error");
          return;
        }

        const message = {
          action: "webrtc_join_room",
          data: {
            room_id: roomId,
            peer_id: currentPeerId,
          },
        };

        ws.send(JSON.stringify(message));
        addMessage(`–ü–æ–ø—ã—Ç–∫–∞ –≤–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, "sent");

        document.getElementById("joinRoomBtn").disabled = true;
        document.getElementById("leaveRoomBtn").disabled = false;

        stats.messagesSent++;
        updateStats();
      }

      function leaveRoom() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω", "error");
          return;
        }

        const roomId = document.getElementById("roomId").value;

        const message = {
          action: "webrtc_leave_room",
          data: {
            room_id: roomId,
            peer_id: currentPeerId,
          },
        };

        ws.send(JSON.stringify(message));
        addMessage(`–ü–æ–∫–∏–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, "sent");

        document.getElementById("joinRoomBtn").disabled = false;
        document.getElementById("leaveRoomBtn").disabled = true;

        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }

        stats.messagesSent++;
        updateStats();
      }

      function setupPeerConnection(targetPeerId) {
        peerConnection = new RTCPeerConnection(rtcConfiguration);

        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º
        if (localStream) {
          localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
          });
        }

        // –°–æ–∑–¥–∞–µ–º data channel
        dataChannel = peerConnection.createDataChannel("messages");
        dataChannel.onopen = function () {
          addMessage("WebRTC data channel –æ—Ç–∫—Ä—ã—Ç", "sent");
        };
        dataChannel.onmessage = function (event) {
          addMessage(`WebRTC —Å–æ–æ–±—â–µ–Ω–∏–µ: ${event.data}`, "received");
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        peerConnection.onicecandidate = function (event) {
          if (event.candidate) {
            const message = {
              action: "webrtc_signal",
              data: {
                signal_type: "ice-candidate",
                peer_id: currentPeerId,
                target_peer_id: targetPeerId,
                ice_candidate: event.candidate,
                room_id: document.getElementById("roomId").value || null,
              },
            };

            ws.send(JSON.stringify(message));
            addMessage("ICE candidate –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω", "sent");
          }
        };

        peerConnection.ontrack = function (event) {
          document.getElementById("remoteVideo").srcObject = event.streams[0];
          addMessage("–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º", "received");
        };

        peerConnection.onconnectionstatechange = function () {
          updateWebRTCInfo();
          addMessage(
            `WebRTC —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.connectionState}`,
            "received"
          );
        };

        peerConnection.ondatachannel = function (event) {
          const channel = event.channel;
          channel.onmessage = function (event) {
            addMessage(`WebRTC data: ${event.data}`, "received");
          };
        };
      }

      function handleWebRTCMessage(message) {
        const data = message.data;

        addMessage(
          `WebRTC —Å–∏–≥–Ω–∞–ª (${data.signal_type}) –æ—Ç ${data.peer_id}`,
          "received"
        );

        if (data.signal_type === "offer") {
          document.getElementById("peerId").value = data.peer_id;
          setupPeerConnection(data.peer_id);

          peerConnection
            .setRemoteDescription(
              new RTCSessionDescription({
                type: "offer",
                sdp: data.sdp,
              })
            )
            .then(() => {
              document.getElementById("createAnswerBtn").disabled = false;
            });
        } else if (data.signal_type === "answer") {
          peerConnection.setRemoteDescription(
            new RTCSessionDescription({
              type: "answer",
              sdp: data.sdp,
            })
          );
        } else if (data.signal_type === "ice-candidate") {
          peerConnection.addIceCandidate(
            new RTCIceCandidate(data.ice_candidate)
          );
        }

        updateWebRTCInfo();
      }

      function updateWebRTCInfo() {
        const info = document.getElementById("webrtcInfo");
        let infoText = "WebRTC —Å—Ç–∞—Ç—É—Å: ";

        if (peerConnection) {
          infoText += `
                    –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${peerConnection.connectionState}<br>
                    ICE: ${peerConnection.iceConnectionState}<br>
                    –°–∏–≥–Ω–∞–ª–∏–Ω–≥: ${peerConnection.signalingState}
                `;
        } else {
          infoText += "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
        }

        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          const audioTrack = localStream.getAudioTracks()[0];
          infoText += `<br>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ: ${
            videoTrack ? (videoTrack.enabled ? "–≤–∫–ª" : "–≤—ã–∫–ª") : "–Ω–µ—Ç"
          }`;
          infoText += `<br>–õ–æ–∫–∞–ª—å–Ω–æ–µ –∞—É–¥–∏–æ: ${
            audioTrack ? (audioTrack.enabled ? "–≤–∫–ª" : "–≤—ã–∫–ª") : "–Ω–µ—Ç"
          }`;
        }

        info.innerHTML = infoText;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ WebRTC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
        document.getElementById("webrtcPeers").textContent = peerConnection
          ? 1
          : 0;
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      setInterval(updateStats, 1000);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      updateConnectionStatus("disconnected", "–û—Ç–∫–ª—é—á–µ–Ω–æ");
      updateStats();
    </script>
  </body>
</html>
