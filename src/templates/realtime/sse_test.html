<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSE –¢–µ—Å—Ç —Å –ë–∏–Ω–∞—Ä–Ω—ã–º–∏ –î–∞–Ω–Ω—ã–º–∏</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }
      .connection-status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      .status-disconnected {
        background: #e74c3c;
        color: white;
      }
      .status-connecting {
        background: #f39c12;
        color: white;
      }
      .status-connected {
        background: #27ae60;
        color: white;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #e74c3c;
      }
      button {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
      }
      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .messages {
        height: 400px;
        overflow-y: auto;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        padding: 15px;
        background: #f8f9fa;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 5px;
        word-wrap: break-word;
      }
      .message-info {
        background: #d1ecf1;
        border-left: 4px solid #bee5eb;
      }
      .message-event {
        background: #d4edda;
        border-left: 4px solid #c3e6cb;
      }
      .message-error {
        background: #f8d7da;
        border-left: 4px solid #f5c6cb;
      }
      .message-binary {
        background: #dda0dd;
        border-left: 4px solid #9932cc;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #ecf0f1;
      }
      .tab {
        padding: 10px 20px;
        background: #ecf0f1;
        cursor: pointer;
        border: none;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        transition: all 0.3s ease;
      }
      .tab.active {
        background: #e74c3c;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #e74c3c;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .stat-label {
        color: #7f8c8d;
        font-size: 12px;
        margin-top: 5px;
      }
      .event-filter {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }
      .event-filter label {
        margin-bottom: 0;
        white-space: nowrap;
      }
      .event-filter select {
        width: auto;
        min-width: 120px;
      }
      .binary-upload {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }
      .file-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .notification-demo {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
      }
      .notification-demo h4 {
        margin: 0 0 10px 0;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üì° Server-Sent Events –¢–µ—Å—Ç —Å –ë–∏–Ω–∞—Ä–Ω—ã–º–∏ –î–∞–Ω–Ω—ã–º–∏</h1>

      <div class="connection-status" id="connectionStatus">
        <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('basic')">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
        <button class="tab" onclick="showTab('binary')">–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button class="tab" onclick="showTab('notifications')">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
        <button class="tab" onclick="showTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ -->
      <div id="basic" class="tab-content active">
        <div class="form-group">
          <label for="sseUrl">SSE URL:</label>
          <input
            type="text"
            id="sseUrl"
            value="http://localhost:8000/realtime/events"
            placeholder="http://localhost:8000/realtime/events"
          />
        </div>

        <div class="form-group">
          <label for="authToken">–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
          <input
            type="text"
            id="authToken"
            placeholder="Bearer token –∏–ª–∏ API key"
          />
        </div>

        <div class="form-group">
          <label for="channel">–ö–∞–Ω–∞–ª –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏:</label>
          <input
            type="text"
            id="channel"
            value="general"
            placeholder="general"
          />
        </div>

        <div class="form-group">
          <label for="userId">User ID (–¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π):</label>
          <input type="text" id="userId" placeholder="user_123" />
        </div>

        <button onclick="connect()" id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()" id="disconnectBtn" disabled>
          –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
        </button>
        <button onclick="requestNotificationPermission()" id="notificationBtn">
          –†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>

        <div class="event-filter">
          <label for="eventTypeFilter">–§–∏–ª—å—Ç—Ä —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π:</label>
          <select id="eventTypeFilter" onchange="updateEventFilter()">
            <option value="all">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
            <option value="message">–°–æ–æ–±—â–µ–Ω–∏—è</option>
            <option value="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
            <option value="binary">–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</option>
            <option value="system">–°–∏—Å—Ç–µ–º–Ω—ã–µ</option>
          </select>

          <label for="showTimestamps">
            <input
              type="checkbox"
              id="showTimestamps"
              checked
              onchange="toggleTimestamps()"
            />
            –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Ä–µ–º—è
          </label>

          <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
      <div id="binary" class="tab-content">
        <div class="form-group">
          <label>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ API (—ç–º—É–ª—è—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è):</label>
          <div class="binary-upload">
            <input
              type="file"
              id="fileInput"
              onchange="handleFileSelect(event)"
            />
            <button onclick="uploadBinaryFile()" id="uploadFileBtn">
              –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
            </button>
          </div>
          <div class="file-info" id="fileInfo"></div>
        </div>

        <div class="form-group">
          <label for="binaryText">–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</label>
          <textarea
            id="binaryText"
            rows="3"
            placeholder="–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API"
          ></textarea>
          <button onclick="sendBinaryText()" id="sendBinaryBtn">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ Binary
          </button>
        </div>

        <div class="form-group">
          <label>–¢–µ—Å—Ç–æ–≤—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</label>
          <button onclick="generateRandomBinary()">
            –°–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (1KB)
          </button>
          <button onclick="generateTestImage()">–¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
          <button onclick="generateJSONData()">JSON –∫–∞–∫ binary</button>
        </div>

        <div class="notification-demo">
          <h4>üí° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ SSE</h4>
          <p>
            SSE –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ—ç—Ç–æ–º—É –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ Base64. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏
            –æ—Ç–ø—Ä–∞–≤–∫—É –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ API, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ç–µ–º –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã
            —á–µ—Ä–µ–∑ SSE –∫–∞–∫ —Å–æ–±—ã—Ç–∏—è —Å Base64-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
          </p>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
      <div id="notifications" class="tab-content">
        <div class="form-group">
          <label for="notificationTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
          <input
            type="text"
            id="notificationTitle"
            value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"
          />
        </div>

        <div class="form-group">
          <label for="notificationBody">–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
          <textarea
            id="notificationBody"
            rows="3"
            placeholder="–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."
          >
–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SSE</textarea
          >
        </div>

        <div class="form-group">
          <label for="notificationIcon">URL –∏–∫–æ–Ω–∫–∏:</label>
          <input
            type="text"
            id="notificationIcon"
            value="/static/notification-icon.png"
            placeholder="URL –∏–∫–æ–Ω–∫–∏"
          />
        </div>

        <div class="form-group">
          <label for="notificationTag">–¢–µ–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
          <input
            type="text"
            id="notificationTag"
            value="test"
            placeholder="test"
          />
        </div>

        <button onclick="sendTestNotification()">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
        </button>
        <button onclick="sendChannelNotification()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª</button>
        <button onclick="sendBroadcastNotification()">–®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–µ</button>

        <div class="notification-demo">
          <h4>üîî –î–µ–º–æ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>
          <p>
            –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ SSE, –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
            –∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ).
          </p>
          <button onclick="showTestBrowserNotification()">
            –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          </button>
        </div>
      </div>

      <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
      <div id="stats" class="tab-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="eventsReceived">0</div>
            <div class="stat-label">–°–æ–±—ã—Ç–∏–π –ø–æ–ª—É—á–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="binaryDataReceived">0 KB</div>
            <div class="stat-label">–ë–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="notificationsShown">0</div>
            <div class="stat-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∫–∞–∑–∞–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="connectionTime">0s</div>
            <div class="stat-label">–í—Ä–µ–º—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="lastEventTime">-</div>
            <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="connectionErrors">0</div>
            <div class="stat-label">–û—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px">
          <label>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º:</label>
          <button onclick="testReconnection()">–¢–µ—Å—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
          <button onclick="checkConnectionHealth()">
            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
          </button>
          <button onclick="resetStats()">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
      </div>

      <div class="form-group">
        <label for="messages">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</label>
        <div class="messages" id="messages"></div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let connectionStartTime = null;
      let stats = {
        eventsReceived: 0,
        binaryDataReceived: 0,
        notificationsShown: 0,
        connectionErrors: 0,
      };
      let eventFilter = "all";
      let showTimestamps = true;

      function showTab(tabName) {
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      function updateConnectionStatus(status, text) {
        const statusElement = document.getElementById("connectionStatus");
        const statusText = document.getElementById("statusText");

        statusElement.className = "connection-status status-" + status;
        statusText.textContent = text;
      }

      function updateStats() {
        document.getElementById("eventsReceived").textContent =
          stats.eventsReceived;
        document.getElementById("binaryDataReceived").textContent =
          (stats.binaryDataReceived / 1024).toFixed(2) + " KB";
        document.getElementById("notificationsShown").textContent =
          stats.notificationsShown;
        document.getElementById("connectionErrors").textContent =
          stats.connectionErrors;

        if (connectionStartTime) {
          const uptime = Math.floor((Date.now() - connectionStartTime) / 1000);
          document.getElementById("connectionTime").textContent = uptime + "s";
        }

        document.getElementById("lastEventTime").textContent =
          stats.lastEventTime
            ? new Date(stats.lastEventTime).toLocaleTimeString()
            : "-";
      }

      function addMessage(message, type = "info", eventType = null) {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
        if (eventFilter !== "all" && eventType && eventType !== eventFilter) {
          return;
        }

        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message message-${type}`;

        let content = message;
        if (showTimestamps) {
          const timestamp = new Date().toLocaleTimeString();
          content = `<strong>[${timestamp}]</strong> ${message}`;
        }

        messageDiv.innerHTML = content;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        stats.eventsReceived++;
        stats.lastEventTime = Date.now();
        updateStats();
      }

      function connect() {
        const url = document.getElementById("sseUrl").value;
        const token = document.getElementById("authToken").value;
        const channel = document.getElementById("channel").value;
        const userId = document.getElementById("userId").value;

        let sseUrl = url;
        const params = new URLSearchParams();

        if (token) params.append("token", token);
        if (channel) params.append("channel", channel);
        if (userId) params.append("user_id", userId);

        if (params.toString()) {
          sseUrl += "?" + params.toString();
        }

        try {
          updateConnectionStatus("connecting", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");

          eventSource = new EventSource(sseUrl);

          eventSource.onopen = function (event) {
            updateConnectionStatus("connected", "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ");
            connectionStartTime = Date.now();

            document.getElementById("connectBtn").disabled = true;
            document.getElementById("disconnectBtn").disabled = false;

            addMessage("SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "info", "system");
          };

          eventSource.onmessage = function (event) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              data = event.data;
            }

            addMessage(
              `–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(data, null, 2)}`,
              "event",
              "message"
            );
          };

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
          eventSource.addEventListener("notification", function (event) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              data = { message: event.data };
            }

            addMessage(
              `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: ${JSON.stringify(data, null, 2)}`,
              "event",
              "notification"
            );

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (Notification.permission === "granted" && data.title) {
              showBrowserNotification(
                data.title,
                data.body || data.message,
                data.icon
              );
            }
          });

          eventSource.addEventListener("binary_data", function (event) {
            let data;
            try {
              data = JSON.parse(event.data);

              if (data.binary_data) {
                const binarySize = atob(data.binary_data).length;
                stats.binaryDataReceived += binarySize;

                addMessage(
                  `–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${binarySize} –±–∞–π—Ç, —Ç–∏–ø: ${
                    data.content_type || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                  }${data.filename ? `, —Ñ–∞–π–ª: ${data.filename}` : ""}`,
                  "binary",
                  "binary"
                );
              }
            } catch (e) {
              addMessage(
                `–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${e.message}`,
                "error",
                "binary"
              );
            }
          });

          eventSource.addEventListener("channel_message", function (event) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              data = { message: event.data };
            }

            addMessage(
              `–°–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ [${
                data.channel || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
              }]: ${JSON.stringify(data.data || data, null, 2)}`,
              "event",
              "message"
            );
          });

          eventSource.addEventListener("system", function (event) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              data = { message: event.data };
            }

            addMessage(
              `–°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: ${JSON.stringify(data, null, 2)}`,
              "event",
              "system"
            );
          });

          eventSource.addEventListener("error", function (event) {
            addMessage(
              `–û—à–∏–±–∫–∞ —Å–æ–±—ã—Ç–∏—è: ${JSON.stringify(event, null, 2)}`,
              "error",
              "system"
            );
          });

          eventSource.onerror = function (event) {
            stats.connectionErrors++;

            if (eventSource.readyState === EventSource.CLOSED) {
              updateConnectionStatus("disconnected", "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
              addMessage("SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å–µ—Ä–≤–µ—Ä–æ–º", "error", "system");

              document.getElementById("connectBtn").disabled = false;
              document.getElementById("disconnectBtn").disabled = true;
              connectionStartTime = null;
            } else {
              addMessage(
                "–û—à–∏–±–∫–∞ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...",
                "error",
                "system"
              );
            }

            updateStats();
          };
        } catch (error) {
          updateConnectionStatus("disconnected", "–û—à–∏–±–∫–∞");
          addMessage(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, "error", "system");
          stats.connectionErrors++;
          updateStats();
        }
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
        }

        updateConnectionStatus("disconnected", "–û—Ç–∫–ª—é—á–µ–Ω–æ");

        document.getElementById("connectBtn").disabled = false;
        document.getElementById("disconnectBtn").disabled = true;

        addMessage("SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", "info", "system");
        connectionStartTime = null;
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          const fileInfo = document.getElementById("fileInfo");
          fileInfo.innerHTML = `
                    <strong>–§–∞–π–ª:</strong> ${file.name}<br>
                    <strong>–†–∞–∑–º–µ—Ä:</strong> ${(file.size / 1024).toFixed(
                      2
                    )} KB<br>
                    <strong>–¢–∏–ø:</strong> ${file.type || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
                `;
        }
      }

      async function uploadBinaryFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          addMessage("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/realtime/binary/upload", {
            method: "POST",
            body: formData,
            headers: {
              Authorization: document.getElementById("authToken").value || "",
            },
          });

          if (response.ok) {
            const result = await response.json();
            addMessage(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`, "info", "binary");
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${response.status}`,
              "error",
              "binary"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ${error.message}`,
            "error",
            "binary"
          );
        }
      }

      async function sendBinaryText() {
        const text = document.getElementById("binaryText").value;
        if (!text) {
          addMessage("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
          return;
        }

        try {
          const response = await fetch("/realtime/binary/text", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              text: text,
              channel: document.getElementById("channel").value || null,
            }),
          });

          if (response.ok) {
            addMessage(
              `–¢–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${text.length} —Å–∏–º–≤–æ–ª–æ–≤`,
              "info",
              "binary"
            );
            document.getElementById("binaryText").value = "";
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞: ${response.status}`,
              "error",
              "binary"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞: ${error.message}`,
            "error",
            "binary"
          );
        }
      }

      async function generateRandomBinary() {
        try {
          const response = await fetch("/realtime/binary/generate/random", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              size: 1024,
              channel: document.getElementById("channel").value || null,
            }),
          });

          if (response.ok) {
            addMessage(
              "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (1KB)",
              "info",
              "binary"
            );
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${response.status}`,
              "error",
              "binary"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`,
            "error",
            "binary"
          );
        }
      }

      async function generateTestImage() {
        try {
          const response = await fetch("/realtime/binary/generate/image", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              width: 200,
              height: 200,
              channel: document.getElementById("channel").value || null,
            }),
          });

          if (response.ok) {
            addMessage("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "info", "binary");
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${response.status}`,
              "error",
              "binary"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error.message}`,
            "error",
            "binary"
          );
        }
      }

      async function generateJSONData() {
        const testData = {
          timestamp: new Date().toISOString(),
          data: {
            numbers: [1, 2, 3, 4, 5],
            message: "–≠—Ç–æ JSON –¥–∞–Ω–Ω—ã–µ, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ",
            nested: {
              value: Math.random(),
              boolean: true,
            },
          },
        };

        try {
          const response = await fetch("/realtime/binary/json", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              data: testData,
              channel: document.getElementById("channel").value || null,
            }),
          });

          if (response.ok) {
            addMessage("JSON –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –±–∏–Ω–∞—Ä–Ω—ã–µ", "info", "binary");
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ JSON: ${response.status}`,
              "error",
              "binary"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ JSON: ${error.message}`,
            "error",
            "binary"
          );
        }
      }

      // –§—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      async function requestNotificationPermission() {
        if ("Notification" in window) {
          const permission = await Notification.requestPermission();
          addMessage(
            `–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${permission}`,
            "info",
            "notification"
          );
        } else {
          addMessage(
            "–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            "error",
            "notification"
          );
        }
      }

      function showBrowserNotification(title, body, icon) {
        if (Notification.permission === "granted") {
          const notification = new Notification(title, {
            body: body,
            icon: icon || "/static/notification-icon.png",
            badge: "/static/badge-icon.png",
            tag: "sse-notification",
          });

          stats.notificationsShown++;
          updateStats();

          notification.onclick = function () {
            window.focus();
            notification.close();
          };

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
          setTimeout(() => notification.close(), 5000);
        }
      }

      async function sendTestNotification() {
        const title = document.getElementById("notificationTitle").value;
        const body = document.getElementById("notificationBody").value;
        const icon = document.getElementById("notificationIcon").value;
        const tag = document.getElementById("notificationTag").value;

        try {
          const response = await fetch("/realtime/notifications/send", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              title: title,
              body: body,
              icon: icon,
              tag: tag,
              user_id: document.getElementById("userId").value || null,
            }),
          });

          if (response.ok) {
            addMessage(
              "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ API",
              "info",
              "notification"
            );
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${response.status}`,
              "error",
              "notification"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${error.message}`,
            "error",
            "notification"
          );
        }
      }

      async function sendChannelNotification() {
        const title = document.getElementById("notificationTitle").value;
        const body = document.getElementById("notificationBody").value;
        const channel = document.getElementById("channel").value;

        try {
          const response = await fetch("/realtime/notifications/channel", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              title: title,
              body: body,
              channel: channel,
            }),
          });

          if (response.ok) {
            addMessage(
              `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª: ${channel}`,
              "info",
              "notification"
            );
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª: ${response.status}`,
              "error",
              "notification"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª: ${error.message}`,
            "error",
            "notification"
          );
        }
      }

      async function sendBroadcastNotification() {
        const title = document.getElementById("notificationTitle").value;
        const body = document.getElementById("notificationBody").value;

        try {
          const response = await fetch("/realtime/notifications/broadcast", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: document.getElementById("authToken").value || "",
            },
            body: JSON.stringify({
              title: title,
              body: body,
            }),
          });

          if (response.ok) {
            addMessage(
              "–®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
              "info",
              "notification"
            );
          } else {
            addMessage(
              `–û—à–∏–±–∫–∞ —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: ${response.status}`,
              "error",
              "notification"
            );
          }
        } catch (error) {
          addMessage(
            `–û—à–∏–±–∫–∞ —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`,
            "error",
            "notification"
          );
        }
      }

      function showTestBrowserNotification() {
        showBrowserNotification(
          "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
          "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏",
          "/static/notification-icon.png"
        );
      }

      // –£—Ç–∏–ª–∏—Ç—ã
      function updateEventFilter() {
        eventFilter = document.getElementById("eventTypeFilter").value;
        addMessage(
          `–§–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${eventFilter}`,
          "info",
          "system"
        );
      }

      function toggleTimestamps() {
        showTimestamps = document.getElementById("showTimestamps").checked;
        addMessage(
          `–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏: ${showTimestamps ? "–≤–∫–ª—é—á–µ–Ω–æ" : "–≤—ã–∫–ª—é—á–µ–Ω–æ"}`,
          "info",
          "system"
        );
      }

      function clearMessages() {
        document.getElementById("messages").innerHTML = "";
        addMessage("–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π –æ—á–∏—â–µ–Ω", "info", "system");
      }

      function testReconnection() {
        if (eventSource) {
          addMessage("–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "info", "system");
          eventSource.close();
          setTimeout(connect, 1000);
        } else {
          addMessage(
            "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
            "error",
            "system"
          );
        }
      }

      function checkConnectionHealth() {
        if (eventSource) {
          const state = eventSource.readyState;
          let stateText = "";
          switch (state) {
            case EventSource.CONNECTING:
              stateText = "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ";
              break;
            case EventSource.OPEN:
              stateText = "–æ—Ç–∫—Ä—ã—Ç–æ";
              break;
            case EventSource.CLOSED:
              stateText = "–∑–∞–∫—Ä—ã—Ç–æ";
              break;
            default:
              stateText = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
          }
          addMessage(
            `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${stateText} (${state})`,
            "info",
            "system"
          );
        } else {
          addMessage("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "error", "system");
        }
      }

      function resetStats() {
        stats = {
          eventsReceived: 0,
          binaryDataReceived: 0,
          notificationsShown: 0,
          connectionErrors: 0,
        };
        connectionStartTime = Date.now();
        updateStats();
        addMessage("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞", "info", "system");
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      updateConnectionStatus("disconnected", "–û—Ç–∫–ª—é—á–µ–Ω–æ");
      updateStats();

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
      setInterval(updateStats, 1000);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      if ("Notification" in window && Notification.permission === "default") {
        addMessage(
          'üí° –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',
          "info",
          "notification"
        );
      }
    </script>
  </body>
</html>
