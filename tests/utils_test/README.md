# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç AsyncApiTestClient

–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚ú® –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ URL

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–∏—Ö URL**: –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤ `url_for()` –∫–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∏–º–µ–Ω–∞ routes
- **–ê–ª–≥–æ—Ä–∏—Ç–º –¥–∏—Ñ—Ñ–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏—Ö –∏–º–µ–Ω
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–æ–º–æ—â—å**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ routes —Å –∏—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º —Å—Ö–æ–∂–µ—Å—Ç–∏

### üîê –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- **–ì–∏–±–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–±—ã—á–Ω—ã–µ, –∞–¥–º–∏–Ω—ã, –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- **JWT —Ç–æ–∫–µ–Ω—ã**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞–º–∏
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ –æ–¥–Ω–æ–º —Ç–µ—Å—Ç–µ
- **–í—Ä–µ–º–µ–Ω–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### üìä –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **–ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤**: –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, —Ä–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞/–æ—Ç–≤–µ—Ç–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: –°—Ä–µ–¥–Ω–µ–µ/–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è, RPS
- **–°–µ—Å—Å–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ —Ç–µ—Å—Ç–æ–≤—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º
- **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### üì∏ –°–Ω–∏–º–∫–∏ API (API Snapshots)

- **–†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è API
- **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤
- **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –°–Ω–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª—ã –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### üîÑ Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã

- **–£–º–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä—ã**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö
- **–ì–∏–±–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**: –õ–∏–Ω–µ–π–Ω–∞—è, —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è, –§–∏–±–æ–Ω–∞—á—á–∏
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —É—Å–ª–æ–≤–∏—è**: –í—ã–±–æ—Ä –∫–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è retry
- **–ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏**: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∂–∏–¥–∞–Ω–∏—è

### üîó Chain —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ —Ü–µ–ø–æ—á–∫–∏
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### üé≠ –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö API

- **–ó–∞–º–µ—â–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤**: –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–Ω–µ—à–Ω–∏–º API
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã**: –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ç–∞—Ç—É—Å –∫–æ–¥–æ–≤, –¥–∞–Ω–Ω—ã—Ö, –∑–∞–¥–µ—Ä–∂–µ–∫
- **–ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–º–æ–∫–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–≠–º—É–ª—è—Ü–∏—è —Å–±–æ–µ–≤**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## üìã –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from tests.utils_test.api_test_client import AsyncApiTestClient
from fastapi import FastAPI

app = FastAPI()

@app.get("/users/{user_id}")
async def get_user(user_id: int):
    return {"user_id": user_id}

async with AsyncApiTestClient(app=app) as client:
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL
    url = client.url_for("get_user", user_id=123)
    print(url)  # "/users/123"

    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    response = await client.get(url)
    assert response.status_code == 200
```

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
async with AsyncApiTestClient(app=app) as client:
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = await client.force_auth(
        email="user@example.com",
        email_verified=True,
        is_active=True
    )

    # –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin = await client.force_auth(
        email="admin@example.com",
        is_superuser=True,
        email_verified=True
    )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    assert client.is_authenticated()
    assert client.get_current_user() == admin
```

### –†–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```python
async with AsyncApiTestClient(app=app) as client:
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user1 = await UserFactory.create(email="user1@test.com")
    user2 = await UserFactory.create(email="user2@test.com", is_superuser=True)

    # –ó–∞–ø—Ä–æ—Å—ã –æ—Ç –∏–º–µ–Ω–∏ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    response1 = await client.get_as_user("/profile", user=user1)
    response2 = await client.get_as_user("/admin/panel", user=user2)

    # –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ URL —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏

```python
async with AsyncApiTestClient(app=app) as client:
    try:
        # –û–ø–µ—á–∞—Ç–∫–∞ –≤ –∏–º–µ–Ω–∏ route
        client.url_for("get_usr", user_id=123)  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å "get_user"
    except ValueError as e:
        print(str(e))
        # Route 'get_usr' –Ω–µ –Ω–∞–π–¥–µ–Ω.
        #
        # –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É –æ–¥–∏–Ω –∏–∑ —ç—Ç–∏—Ö routes:
        #   - get_user (—Å—Ö–æ–∂–µ—Å—Ç—å: 85.71%)
        #   - get_user_posts (—Å—Ö–æ–∂–µ—Å—Ç—å: 76.92%)
        #   - get_user_profile (—Å—Ö–æ–∂–µ—Å—Ç—å: 72.73%)
        #
        # –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ routes (3):
        #   - get_user
        #   - get_user_posts
        #   - get_user_profile
```

## üîß API Reference

### AsyncApiTestClient

#### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```python
AsyncApiTestClient(app: Optional[FastAPI] = None, **kwargs)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `app`: –≠–∫–∑–µ–º–ø–ª—è—Ä FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `**kwargs`: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è httpx.AsyncClient

#### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

##### url_for(name: str, /, \*\*path_params) -> str

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è endpoint —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `name`: –ò–º—è route —Ñ—É–Ω–∫—Ü–∏–∏
- `**path_params`: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É—Ç–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL

**Raises:** `ValueError` —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –ø–æ—Ö–æ–∂–∏—Ö routes

##### force_auth(\*\*kwargs) -> User

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `user`: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ email)
- `email`: Email –¥–ª—è –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `email_verified`: –°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email (default: True)
- `is_superuser`: –ü—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (default: False)
- `is_active`: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (default: True)
- `**user_kwargs`: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

##### force_logout() -> None

–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã - —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

#### HTTP –º–µ—Ç–æ–¥—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

```python
# –ó–∞–ø—Ä–æ—Å—ã –æ—Ç –∏–º–µ–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def get_as_user(url: str, user: Optional[User] = None, **kwargs) -> Response
async def post_as_user(url: str, user: Optional[User] = None, **kwargs) -> Response
async def put_as_user(url: str, user: Optional[User] = None, **kwargs) -> Response
async def delete_as_user(url: str, user: Optional[User] = None, **kwargs) -> Response
```

#### –£—Ç–∏–ª–∏—Ç—ã

```python
def is_authenticated() -> bool              # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
def get_current_user() -> Optional[User]    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_auth_headers() -> dict[str, str]    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
def clear_cache() -> None                   # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ routes
```

## üéØ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏

```python
@pytest.mark.parametrize("user_type,expected_status", [
    ("regular", 403),
    ("admin", 200),
    ("superuser", 200)
])
async def test_endpoint_access(user_type, expected_status):
    async with AsyncApiTestClient(app=app) as client:
        if user_type == "regular":
            await client.force_auth(is_superuser=False)
        elif user_type == "admin":
            await client.force_auth(is_superuser=True)

        response = await client.get("/admin/endpoint")
        assert response.status_code == expected_status
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ workflow —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```python
async def test_collaboration_workflow():
    async with AsyncApiTestClient(app=app) as client:
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è
        author = await UserFactory.create(email="author@test.com")
        reviewer = await UserFactory.create(email="reviewer@test.com", is_superuser=True)

        # 1. –ê–≤—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
        response = await client.post_as_user(
            "/documents",
            user=author,
            json={"title": "New Document", "content": "Draft content"}
        )
        doc_id = response.json()["id"]

        # 2. –†–µ—Ü–µ–Ω–∑–µ–Ω—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
        response = await client.get_as_user(f"/documents/{doc_id}", user=reviewer)
        assert response.status_code == 200

        # 3. –†–µ—Ü–µ–Ω–∑–µ–Ω—Ç –æ–¥–æ–±—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
        response = await client.post_as_user(
            f"/documents/{doc_id}/approve",
            user=reviewer
        )
        assert response.status_code == 200
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
async def test_performance_optimization():
    async with AsyncApiTestClient(app=app) as client:
        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–µ—à–∞ routes
        available_routes = client._get_available_routes()
        print(f"–î–æ—Å—Ç—É–ø–Ω–æ routes: {len(available_routes)}")

        # –ü–∞–∫–µ—Ç–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        users = []
        for i in range(10):
            user = await client.force_auth(email=f"user{i}@test.com")
            users.append(user)

        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
        tasks = []
        for user in users:
            task = client.get_as_user("/profile", user=user)
            tasks.append(task)

        responses = await asyncio.gather(*tasks)
        assert all(r.status_code == 200 for r in responses)
```

## üö® –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤

–ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä–æ–≥—É—é —Ç–∏–ø–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
user: Optional[User] = None
email: Optional[str] = None

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
user: User = None  # Type error!
email: str = None  # Type error!
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ context manager:

```python
# ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
async with AsyncApiTestClient(app=app) as client:
    await client.force_auth(...)
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

# ‚ùå –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —É—Ç–µ—á–∫–∞–º)
client = AsyncApiTestClient(app=app)
await client.force_auth(...)
# –ù—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–∑–≤–∞—Ç—å client.force_logout()
```

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ routes

–ö–µ—à routes –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –Ω–æ –ø—Ä–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ routes –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```python
client.clear_cache()  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
```

## üõ† –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pytest fixtures**:

```python
@pytest.fixture
async def authenticated_client(app):
    async with AsyncApiTestClient(app=app) as client:
        await client.force_auth(is_superuser=True)
        yield client
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤**:

```python
class AdminTestClient(AsyncApiTestClient):
    async def __aenter__(self):
        await super().__aenter__()
        await self.force_auth(is_superuser=True)
        return self
```

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAPI**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL –Ω–∞ –æ—Å–Ω–æ–≤–µ OpenAPI —Å—Ö–µ–º—ã
2. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket**: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
4. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤**: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö
5. **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

`AsyncApiTestClient` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–æ—â–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —É–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö URL –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è—é—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Ç–µ—Å—Ç–æ–≤ –∏ —Å–Ω–∏–∂–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—á–∞—Ç–æ–∫.
